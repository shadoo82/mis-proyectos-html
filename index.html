<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Libro de Órdenes PRO - Binance Futures</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
  body{background:#1a1a1a;color:#fff;font-family:Arial,sans-serif;margin:0;padding:10px;}
  .header{background:#2a2a2a;padding:12px;border-radius:8px;border-radius:8px;margin-bottom:15px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;}
  #symbol-title{font-size:24px;font-weight:bold;color:#0f0;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
  th,td{padding:7px 5px;border:1px solid #444;text-align:center;}
  th{background:#333;color:#0f9;position:sticky;top:0;}
  .ask{color:#ff5555;}
  .bid{color:#55ff55;}
  .delta-up{color:#0f0;font-weight:bold;}
  .delta-down{color:#f66;font-weight:bold;}
  .ice{color:#0ff;font-weight:bold;}
  .price{cursor:pointer;}
  .price:hover{background:#006400;}
  #chart{width:100%;height:500px;background:#222;margin:20px 0;border-radius:8px;}
  .panel{flex:1;min-width:320px;background:#2a2a2a;padding:15px;border-radius:8px;}
  .container{display:flex;gap:15px;flex-wrap:wrap;}
  .copied{background:#0f0 !important;color:#000;}
  .spinner{display:inline-block;width:12px;height:12px;border:2px solid #333;border-top:2px solid #0f0;border-radius:50%;animation:s 1s linear infinite;}
  @keyframes s{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="header">
  <div>
    <input type="text" id="s" value="BTCUSDT" placeholder="Par" list="l" style="padding:8px;background:#333;border:1px solid #555;color:#fff;border-radius:4px;">
    <datalist id="l"></datalist>
    <strong id="symbol-title">BTCUSDT: cargando...</strong>
    <span id="funding">Funding: 0.0000%</span>
    <span id="ping">0ms</span>
  </div>
  <div style="font-size:12px;">
    <span id="time"></span> | Procesadas: <span id="c">0</span> | <span id="status">Conectando...</span>
  </div>
</div>

<div id="chart"></div>

<div class="container">
  <div class="panel">
    <h2 style="text-align:center;color:#f66;">ASKS (VENTA)</h2>
    <table><thead><tr>
      <th>#</th><th>Age</th><th>Precio</th><th>Cant</th><th>USDT</th><th>Δ</th><th>Ice</th>
    </tr></thead><tbody id="asks"></tbody></table>
  </div>
  <div class="panel">
    <h2 style="text-align:center;color:#6f6;">BIDS (COMPRA)</h2>
    <table><thead><tr>
      <th>#</th><th>Age</th><th>Precio</th><th>Cant</th><th>USDT</th><th>Δ</th><th>Ice</th>
    </tr></thead><tbody id="bids"></tbody></table>
  </div>
</div>

<script>
let symbol = "BTCUSDT";
const url = new URLSearchParams(location.search);
if(url.get("symbol")) symbol = url.get("symbol").toUpperCase();
document.getElementById("s").value = symbol;

let mark = 0, funding = 0, lastUpdate = 0, ping = 0;
let asks = new Map(), bids = new Map();
let prevAsk = new Map(), prevBid = new Map();
let iceberg = new Set();

// WebSockets
const depth = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@depth@100ms`);
const markWs = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@markPrice@1s`);

depth.onopen = () => document.getElementById("status").innerHTML = "Conectado <span class='spinner'></span>";
depth.onmessage = e => {
  const d = JSON.parse(e.data);
  if(d.a) process(d.a, true);
  if(d.b) process(d.b, false);
  render();
};

markWs.onmessage = e => {
  const d = JSON.parse(e.data);
  if(d.s === symbol){
    mark = parseFloat(d.p);
    funding = parseFloat(d.r)*100;
    lastUpdate = Date.now();
    document.getElementById("symbol-title").textContent = `${symbol}: $${mark.toFixed(2)}`;
    document.getElementById("funding").textContent = `Funding: ${funding>0?"+":""}${funding.toFixed(4)}%`;
    document.getElementById("funding").style.color = funding>0?"#6f6":"#f66";
  }
};

function process(arr, isAsk){
  const map = isAsk ? asks : bids;
  const prev = isAsk ? prevAsk : prevBid;
  arr.forEach(([p,q]) => {
    p = parseFloat(p); q = parseFloat(q);
    const old = prev.get(p)||0;
    const delta = q - old;
    if(q===0){
      map.delete(p); prev.delete(p); iceberg.delete(p);
    }else{
      if(old>0 && Math.abs(q-old)<old*0.2 && q>old*0.8) iceberg.add(p); // iceberg
      if(old>q*3 && q<old*0.3 && old*p>3e7){ // sweep
        alert(`SWEEP ${isAsk?"ASK":"BID"} → $${((old-q)*p/1e6).toFixed(1)}M`);
        new Audio("https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3").play();
      }
      map.set(p, {p, q, u:p*q, d:delta, i:iceberg.has(p), a:Date.now()});
      prev.set(p, q);
    }
  });
}

function render(){
  ["asks","bids"].forEach(side=>{
    const isAsk = side==="asks";
    const data = Array.from((isAsk?asks:bids).values())
      .sort((a,b)=>isAsk?b.u-a.u:a.u-b.u).slice(0,20);
    const tbody = document.getElementById(side);
    tbody.innerHTML="";
    data.forEach((o,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${Math.floor((Date.now()-o.a)/1000)}s</td>
        <td class="price" onclick="navigator.clipboard.writeText('${o.p}')||this.classList.add('copied')||setTimeout(()=>this.classList.remove('copied'),500)">
          ${o.p.toFixed(2)}
        </td>
        <td>${(o.q>999?o.q/1000.toFixed(1)+"k":o.q.toFixed(3))}</td>
        <td>${(o.u/1e6).toFixed(2)}M</td>
        <td class="${o.d>0?"delta-up":o.d<0?"delta-down":""}">${o.d>0?"+":""}${(Math.abs(o.d)/1000).toFixed(1)}k</td>
        <td>${o.i?"ICE":""}</td>
      `;
      if(isAsk) tr.classList.add("ask"); else tr.classList.add("bid");
      tbody.appendChild(tr);
    });
  });
}

// Ping + hora
setInterval(()=>{
  if(lastUpdate) ping = Date.now()-lastUpdate;
  document.getElementById("ping").textContent = ping+"ms";
  document.getElementById("ping").style.color = ping>800?"#f66":"#6f6";
  document.getElementById("time").textContent = new Date().toLocaleTimeString();
},1000);

// Lista de símbolos
fetch("https://fapi.binance.com/fapi/v1/exchangeInfo")
  .then(r=>r.json())
  .then(d=>{
    const list = document.getElementById("l");
    d.symbols.filter(s=>s.quoteAsset==="USDT").forEach(s=>{
      const op = document.createElement("option");
      op.value = s.symbol;
      list.appendChild(op);
    });
  });

document.getElementById("s").addEventListener("change",e=>{
  if(e.target.value) location.href = "?symbol="+e.target.value.toUpperCase();
});
</script>
</body>
</html>
